<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>人力ソートツール</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <meta name="twitter:card" content="summary">
    <meta property="og:title" content="人力ソートツール">
    <meta property="og:description" content="言葉を並び替えます。好きな○○ランキングなどを作るとき便利です。">
</head>
<body>

  <section class="container">
    <div class="row" id="input-form">
      <p class="col-12">ソートしたい言葉を下のテキストエリアに入力し（1行に1つ）、スタートボタンを押してください。</p>
      <textarea rows="10" cols="10" class="col-12 form-control" id="text-sort" placeholder="ソートしたい言葉を入力してください"></textarea>
      <button class="col-12 btn btn-primary" id="btn-start">スタート</button>
    </div>

    <div class="row d-none" id="sorter">
        <div class="col-12">
            <progress id="progress" value="0" max="1" class="w-100"></progress>
        </div>
        <div class="col-12 alert alert-secondary text-center my-1" id="word-h">high</div>
        <div class="col-12">
            <div class="row">
                <div class="col-6"><button type="button" class="btn btn-success w-100" id="btn-ok">OK</button></div>
                <div class="col-6"><button type="button" class="btn btn-warning w-100" id="btn-swap">Swap</button></div>
            </div>
        </div>
        <div class="col-12 alert alert-secondary text-center my-1" id="word-l">low</div>
    </div>
    
    <div class="row d-none" id="result">
        <textarea rows="10" cols="10" class="form-control col-12" id="text-result" readonly></textarea>
        <button type="button" class="col-12 btn btn-primary" id="btn-again">もう一度</button>
    </div>
  </section>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

  <script>
class Sorter {
    constructor(array) {
        this.array = array;
        this.progress = 0;
    }

    async sort(cmp) {
        this.progress = 0;
        let finished = 0;
        const all = this.array.length * 2;
        let sort = async (array) => {
            if (array.length <= 1) {
                finished += array.length;
                return array;
            }
            const rem = array.length;
            const half = array.length >> 1;
            const front = await sort(array.slice(0, half));
            const rear = await sort(array.slice(half));
            const result = [];
            let l = 0;
            let r = 0;
            while (l < front.length && r < rear.length) {
                if ((await cmp(front[l], rear[r])) <= 0) {
                    result.push(front[l++]);
                } else {
                    result.push(rear[r++]);
                }
                this.progress = (finished + result.length) / all;
            }
            while (l < front.length) {
                result.push(front[l++]);
            }
            while (r < rear.length) {
                result.push(rear[r++]);
            }
            finished += result.length;
            return result;
        };
        this.progress = 1;
        this.array = await sort(this.array);
    }
}

let ok = () => {};
let swap = () => {};
$("#btn-ok").click(() => ok());
$("#btn-swap").click(() => swap());

$("#btn-again").click(() => {
    $("#text-sort").val($("#text-result").val());
    $("#result").addClass("d-none");
    $("#input-form").removeClass("d-none");
});

$("#btn-start").click(async () => {
    $("#input-form").addClass("d-none");
    const text = $("#text-sort").val().split(/\n+/);

    const sorter = new Sorter(text);
    $("#sorter").removeClass("d-none");
    await sorter.sort((h, l) => {
        $("#progress").val(sorter.progress);
        $("#word-h").text(h);
        $("#word-l").text(l);
        const { promise, resolve, reject } = Promise.withResolvers();
        ok = () => resolve(-1);
        swap = () => resolve(1);
        return promise;
    });

    $("#sorter").addClass("d-none");
    $("#text-result").val(sorter.array.join("\n"));
    $("#result").removeClass("d-none");
});
  </script>
</body>
